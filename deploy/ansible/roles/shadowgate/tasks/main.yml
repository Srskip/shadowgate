# ShadowGate Ansible Role - Main Tasks
---

- name: Create shadowgate group
  ansible.builtin.group:
    name: "{{ shadowgate_group }}"
    system: true
    state: present

- name: Create shadowgate user
  ansible.builtin.user:
    name: "{{ shadowgate_user }}"
    group: "{{ shadowgate_group }}"
    system: true
    shell: /sbin/nologin
    home: "{{ shadowgate_data_dir }}"
    create_home: false
    state: present

- name: Create directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ shadowgate_user }}"
    group: "{{ shadowgate_group }}"
    mode: "0755"
  loop:
    - "{{ shadowgate_install_dir }}"
    - "{{ shadowgate_config_dir }}"
    - "{{ shadowgate_log_dir }}"
    - "{{ shadowgate_data_dir }}"

- name: Download shadowgate binary
  ansible.builtin.get_url:
    url: "{{ shadowgate_binary_url }}"
    dest: "{{ shadowgate_install_dir }}/shadowgate"
    owner: root
    group: root
    mode: "0755"
  when: shadowgate_binary_url | length > 0
  notify: Restart shadowgate

- name: Copy shadowgate binary from local
  ansible.builtin.copy:
    src: "shadowgate"
    dest: "{{ shadowgate_install_dir }}/shadowgate"
    owner: root
    group: root
    mode: "0755"
  when: shadowgate_binary_url | length == 0
  notify: Restart shadowgate

- name: Deploy configuration file
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ shadowgate_config_dir }}/config.yaml"
    owner: "{{ shadowgate_user }}"
    group: "{{ shadowgate_group }}"
    mode: "0640"
  notify: Reload shadowgate

- name: Copy TLS certificate
  ansible.builtin.copy:
    src: "{{ shadowgate_tls_cert_file }}"
    dest: "{{ shadowgate_config_dir }}/server.crt"
    owner: "{{ shadowgate_user }}"
    group: "{{ shadowgate_group }}"
    mode: "0644"
  when: shadowgate_tls_enabled and shadowgate_tls_cert_file | length > 0
  notify: Restart shadowgate

- name: Copy TLS private key
  ansible.builtin.copy:
    src: "{{ shadowgate_tls_key_file }}"
    dest: "{{ shadowgate_config_dir }}/server.key"
    owner: "{{ shadowgate_user }}"
    group: "{{ shadowgate_group }}"
    mode: "0600"
  when: shadowgate_tls_enabled and shadowgate_tls_key_file | length > 0
  notify: Restart shadowgate

- name: Deploy systemd service file
  ansible.builtin.template:
    src: shadowgate.service.j2
    dest: /etc/systemd/system/{{ shadowgate_service_name }}.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart shadowgate

- name: Enable and start shadowgate service
  ansible.builtin.systemd:
    name: "{{ shadowgate_service_name }}"
    enabled: "{{ shadowgate_service_enabled }}"
    state: "{{ shadowgate_service_state }}"
    daemon_reload: true

- name: Configure firewalld
  ansible.posix.firewalld:
    port: "{{ item.port }}/tcp"
    zone: "{{ item.zone | default('public') }}"
    permanent: true
    immediate: true
    state: enabled
  loop:
    - { port: "{{ shadowgate_http_port }}" }
    - { port: "{{ shadowgate_https_port }}" }
  when: shadowgate_manage_firewall and ansible_facts['os_family'] == 'RedHat'
  ignore_errors: true
